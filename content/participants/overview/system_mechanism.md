---
date: '2025-10-30T14:00:00+09:00'
draft: false
title: '人狼知能の仕組み'
category: participants_guide
---

こちらのページでは、**aiwolf-nlp-agent-llm（エージェント）**・**aiwolf-nlp-server（ゲームサーバ）**・**aiwolf-nlp-common（共通型ライブラリ）**の3つが、どのように連携してゲームを進行するかを、**実際のデータの流れ**に沿って解説します。

---

## 3つのコンポーネントの役割

### aiwolf-nlp-server（ゲームサーバ）

* ゲーム進行（昼/夜/各フェーズ）を管理し、**WebSocket**で各エージェントへ**JSON文字列**のリクエストを送信します。
* 投票・占い・護衛・襲撃などの結果を集計し、勝敗判定・ログ出力（`.log` / JSON）を行います。
* デフォルト接続先：`ws://127.0.0.1:8080/ws`（ローカル実行時）。

### aiwolf-nlp-agent-llm（サンプルエージェント）

* サーバからのJSONリクエストを受け取り、**自然言語の発話**や**行動対象（プレイヤー名）**を**生の文字列**で返信します。
* `config/config.yml` の設定に従い、OpenAI/Gemini/Ollama などの **LLM を初期化**し、プロンプト（Jinja2テンプレート）から応答を生成します。
* ログ（LLM入出力・最終返答など）を**エージェントごと**に記録します。

### aiwolf-nlp-common（共通型ライブラリ）

* サーバから届く**JSON文字列**を、`Packet/Info/Setting/Talk/...` などの **型付きオブジェクト**に変換します。
* エージェント側はこれを使って**安全かつ簡単に**ゲーム状態にアクセスできます。

---

## 全体像（シーケンス）

* **接続と名乗り**

> * エージェントは WebSocket でサーバに接続します（URL／必要ならトークン）。
> * サーバから NAME が届くと、エージェントは 「チーム名＋連番」（例：kanolab1）を返します。

* **初期化（INITIALIZE）**

> * サーバは INITIALIZE を送って、役職や設定（発言制限・タイムアウト等）を知らせます。
> * エージェント側ではこの JSON を aiwolf-nlp-common でパースして型付きオブジェクトに変換し、役職に応じて LLM の初期化 と 履歴のリセット を行います。\
> この段階では 返信は不要 です。

* **昼のはじまり（DAILY_INITIALIZE）**

> * 新しい日が始まると DAILY_INITIALIZE が届きます（前日の追放・襲撃・占い/霊媒結果などが含まれることあり）。\
> ここでも 返信は不要 です。

* **会話（TALK）**

> * サーバから TALK が来るたびに、直近の差分の会話履歴や残り発言回数が渡されます。
> * エージェントはテンプレート（Jinja2）でプロンプトを組み立てて LLM を呼び出し、
自然言語の一文で返答します。

* **投票（VOTE）**

> * 昼の最後に VOTE が届きます。
> * エージェントは 投票先の“ゲーム内表示名” を返します（info.status_map のキーと一致させる）。

* **夜の行動**

> * 役職に応じて、サーバから DIVINE（占い）／GUARD（護衛）／ATTACK（襲撃）／WHISPER（囁き） が届きます。
> * エージェントは 対象名（ゲーム内表示名）や 囁きの文を返します。
※ 囁きは 人狼が2名以上生存している場合のみ行われます。

* **終了（FINISH）**

> * ゲームが終わると FINISH が届きます（最終情報が含まれる）。返信は不要です。
> * 設定で auto_reconnect=true の場合は、そのまま同じ設定で再接続を試みます。

## リクエストと返答の対応（要点だけ）

| リクエスト              | 説明                         | エージェントの返答     |
| ------------------ | -------------------------- | ------------- |
| `NAME`             | 接続直後に送信。**team名+連番**でユニーク化 | 例: `kanolab1` |
| `INITIALIZE`       | 役職/設定配布、ゲーム開始              | 返答不要（内部初期化）   |
| `DAILY_INITIALIZE` | 昼開始（前夜結果が含まれることあり）         | 返答不要          |
| `TALK`             | 会話要求（**差分履歴**が届く）          | **自然言語**の一文   |
| `WHISPER`          | 人狼間の囁き（人狼2名以上生存時）          | **自然言語**の一文   |
| `VOTE`             | 追放投票                       | **対象プレイヤー名**  |
| `DIVINE`           | 占い対象の指名（占い師のみ）             | **対象プレイヤー名**  |
| `GUARD`            | 護衛対象の指名（騎士のみ）              | **対象プレイヤー名**  |
| `ATTACK`           | 襲撃対象の投票（人狼のみ）              | **対象プレイヤー名**  |
| `DAILY_FINISH`     | 昼終了（会話の最終履歴が届く）            | 返答不要          |
| `FINISH`           | ゲーム終了                      | 返答不要          |

> [!NOTE]
> サーバは**会話/囁き履歴を差分**で送ります。エージェント側は `set_packet()` で内部に**蓄積**し、プロンプトでは `talk_history[sent_talk_count:]` のように**新規分だけ**読ませる実装になっています。

---

## 何が JSON に入ってくるか

* **`request`**：`NAME/TALK/.../FINISH` の種別
* **`info`**：現在のゲーム状態（例：`day`・自分の `agent` 名・`status_map`・占い/霊媒結果・前日追放/襲撃結果・残り発言回数 等）
* **`setting`**：ゲーム設定（プレイヤー数、投票公開、**発言回数/文字数制限**、**タイムアウト** など）
* **`talk_history` / `whisper_history`**：直近の**差分**履歴
* これらは **aiwolf-nlp-common** の `Packet/Info/Setting/Talk/...` クラスで表現されます。

---

## エージェント側の処理

* `starter.py` がサーバと接続し、**受信した JSON** を `Packet.from_dict()` でパース → `agent.set_packet()` に渡します。
* `agent.action()` が `request` に応じて `talk/divine/vote/...` を呼び出し、必要なら **LLM へプロンプト送信**して返答を生成します。
* LLM は `config/config.yml` の `llm.type`（`openai`/`google`/`ollama`）に従い初期化され、**.env（APIキー）**を参照します。
* **タイムアウト**はサーバ設定（`setting.timeout.action`）に依存。超過時は警告し、`agent.kill_on_timeout` が `true` なら**実行を停止**します（フォールバックとしてランダム選択を行う行動メソッドもあり）。

---

## ログと解析へのつながり

* **サーバ側**

  * `game_logger`: 進行ログ（`.log`）— **ゲームの出来事**を記録。
  * `json_logger`: サーバ⇔エージェントの**通信内容を JSON**で記録。
  * これらは **aiwolf-nlp-viewer**（可視化）や **aiwolf-nlp-llm-judge**（LLM 評価）で活用可能。
* **エージェント側**

  * `agent_logger.py` が、**受信パケット（DEBUG）**・**LLM入出力（INFO）**・**最終返答（INFO）**を、エージェント単位で出力します。

---

以上で人狼知能エージェントがどのような仕組みで動いているのかについての解説を完了します。

---

[参加者マニュアルトップへ](../_index.md)\
[概要トップへ](./_index.md)\
[前へ（人狼知能大会のゲームロジックの実装）](./aiwolf_logic.md)\
[次へ（AIWolfDialリポジトリの説明）](./aiwolfdial_repo.md)
